<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>J&M Clothes</title>
  <meta name="viewport"
    content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css"
    integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
  <!-- Fuente bajada de google-->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
  <!-- Font Awesome Stylesheet -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css">
  <!-- Bootstrap core CSS -->
  <link href="/bootstrap/css/bootstrap.min.css" rel="stylesheet">

  <link href="/stylesheets/detalle-producto.css" rel="stylesheet">


  <script>
    window.onload = function () {
      // Variables
      let baseDeDatos = [
        {
          id: 1,
          nombre: 'Mile High Super Skinny',
          precio: 4290,
          imagen: 'https://www.levi.com.ar/media/catalog/product/cache/179/image/9df78eab33525d08d6e5fb8d27136e95/l/e/levis_2279100830_0878_1.jpg'
        },
        {
          id: 2,
          nombre: 'The Trucker Jacket',
          precio: 5980,
          imagen: 'https://www.levi.com.ar/media/catalog/product/cache/179/image/9df78eab33525d08d6e5fb8d27136e95/l/e/levis_7233401330_0129_1_3.jpg'
        },
        {
          id: 3,
          nombre: '711 Skinny',
          precio: 3890,
          imagen: 'https://www.levi.com.ar/media/catalog/product/cache/179/image/9df78eab33525d08d6e5fb8d27136e95/l/e/levis_1888100120_0033_1_3.jpg'
        },
        {
          id: 4,
          nombre: 'Classic One Pocket',
          precio: 2980,
          imagen: 'https://www.levi.com.ar/media/catalog/product/cache/179/image/9df78eab33525d08d6e5fb8d27136e95/l/e/levis_6582476480_0790_1.jpg'
        }

      ]
      let $items = document.querySelector('#items');
      let carrito = [];
      let total = 0;
      let $carrito = document.querySelector('#carrito');
      let $total = document.querySelector('#total');
      // Funciones
      function renderItems() {
        for (let info of baseDeDatos) {
          // Estructura
          let miNodo = document.createElement('div');
          miNodo.classList.add('card', 'col-sm-4');
          // Body
          let miNodoCardBody = document.createElement('div');
          miNodoCardBody.classList.add('card-body');
          // Titulo
          let miNodoTitle = document.createElement('h5');
          miNodoTitle.classList.add('card-title');
          miNodoTitle.textContent = info['nombre'];
          // Imagen
          let miNodoImagen = document.createElement('img');
          miNodoImagen.classList.add('img-fluid');
          miNodoImagen.setAttribute('src', info['imagen']);
          // Precio
          let miNodoPrecio = document.createElement('p');
          miNodoPrecio.classList.add('card-text');
          miNodoPrecio.textContent = '$' + info['precio'];
          // Boton 
          let miNodoBoton = document.createElement('button');
          miNodoBoton.classList.add('btn', 'btn-dark');
          miNodoBoton.textContent = '+';
          miNodoBoton.setAttribute('marcador', info['id']);
          miNodoBoton.addEventListener('click', anyadirCarrito);
          // Insertamos
          miNodoCardBody.appendChild(miNodoImagen);
          miNodoCardBody.appendChild(miNodoTitle);
          miNodoCardBody.appendChild(miNodoPrecio);
          miNodoCardBody.appendChild(miNodoBoton);
          miNodo.appendChild(miNodoCardBody);
          $items.appendChild(miNodo);
        }
      }

      function anyadirCarrito() {
        // Anyadimos el Nodo a nuestro carrito
        carrito.push(this.getAttribute('marcador'))
        // Calculo el total
        calcularTotal();
        // Renderizamos el carrito 
        renderizarCarrito();
      }

      function renderizarCarrito() {
        // Vaciamos todo el html
        $carrito.textContent = '';
        // Quitamos los duplicados
        let carritoSinDuplicados = [...new Set(carrito)];
        // Generamos los Nodos a partir de carrito
        carritoSinDuplicados.forEach(function (item, indice) {
          // Obtenemos el item que necesitamos de la variable base de datos
          let miItem = baseDeDatos.filter(function (itemBaseDatos) {
            return itemBaseDatos['id'] == item;
          });
          // Cuenta el n√∫mero de veces que se repite el producto
          let numeroUnidadesItem = carrito.reduce(function (total, itemId) {
            return itemId === item ? total += 1 : total;
          }, 0);
          // Creamos el nodo del item del carrito
          let miNodo = document.createElement('li');
          miNodo.classList.add('list-group-item', 'text-right', 'mx-2');
          miNodo.textContent = `${numeroUnidadesItem} x ${miItem[0]['nombre']} - $ ${miItem[0]['precio']}`;
          // Boton de borrar
          let miBoton = document.createElement('button');
          miBoton.classList.add('btn', 'btn-danger', 'mx-5');
          miBoton.textContent = 'X';
          miBoton.style.marginLeft = '1rem';
          miBoton.setAttribute('item', item);
          miBoton.addEventListener('click', borrarItemCarrito);
          // Mezclamos nodos
          miNodo.appendChild(miBoton);
          $carrito.appendChild(miNodo);
        })
      }

      function borrarItemCarrito() {
        console.log()
        // Obtenemos el producto ID que hay en el boton pulsado
        let id = this.getAttribute('item');
        // Borramos todos los productos
        carrito = carrito.filter(function (carritoId) {
          return carritoId !== id;
        });
        // volvemos a renderizar
        renderizarCarrito();
        // Calculamos de nuevo el precio
        calcularTotal();
      }

      function calcularTotal() {
        // Limpiamos precio anterior
        total = 0;
        // Recorremos el array del carrito
        for (let item of carrito) {
          // De cada elemento obtenemos su precio
          let miItem = baseDeDatos.filter(function (itemBaseDatos) {
            return itemBaseDatos['id'] == item;
          });
          total = total + miItem[0]['precio'];
        }
        // Formateamos el total para que solo tenga dos decimales
        let totalDosDecimales = total.toFixed(2);
        // Renderizamos el precio en el HTML
        $total.textContent = totalDosDecimales;
      }
      // Eventos

      // Inicio
      renderItems();
    } 
  </script>

</head>

<body style="margin: 0; background: url(https://wallpaperaccess.com/full/446984.jpg) no-repeat center; background-size: cover;">

  <%- include('partials/headerNavbar') %>

  <div class="container">
    <div class="row">
      <!-- Elementos generados a partir del JSON -->
      <main id="items" class="col-sm-8 row" style="margin-top: 3vh;"></main>
      <!-- Carrito -->
      <aside class="col-sm-4">
        <h2 style="margin-top: 20px;">Carrito</h2>
        <!-- Elementos del carrito -->
        <ul id="carrito" class="list-group"></ul>
        <hr>
        <!-- Precio total -->
        <p class="text-left">Total: $ <span id="total"></span></p>
        <button type="button" class="btn btn-dark">Comprar</button>
      </aside>
    </div>
  </div>

  <%- include('partials/footer')%>

</body>

</html>